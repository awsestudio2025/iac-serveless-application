name: Terraform CI/CD (Autenticación OIDC)

# ----------------------------------------------------------------------
# 1. Definición de Triggers (Cuando se ejecuta)
# ----------------------------------------------------------------------
on:
  push:
    branches:
      - main # Ejecutar Plan y Apply cuando hay un push a 'main'
  pull_request:
    branches:
      - main # Ejecutar solo Plan cuando hay un Pull Request

# ----------------------------------------------------------------------
# 2. Permisos y Variables Globales
# ----------------------------------------------------------------------
permissions:
  # CRÍTICO: Habilita la autenticación OIDC para asumir el rol de AWS.
  id-token: write 
  contents: read
  
env:
  TF_WORKING_DIR: template/ 

jobs:
  # Job 1: Terraform Plan
  terraform-plan:
    name: "Terraform Plan: Validar y Previsualizar Cambios"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # 3.1. Configurar Credenciales de AWS usando OIDC
      - name: Configure AWS Credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Es CRÍTICO que la región aquí sea la correcta (us-east-1)
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }} 
          aws-region: us-east-1 

      # 3.2. Terraform Init
      - name: Terraform Init
        # Inicializa Terraform en el directorio 'template/'
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
      
      # 3.3. Terraform Plan (USANDO -var-file)
      - name: Terraform Plan
        id: plan
        run: |
          # Cargamos todas las variables estáticas del archivo prod.tfvars 
          # y pasamos la contraseña (el secreto) directamente con -var.
          terraform plan -input=false -out=tfplan \
            -var-file="prod.tfvars" \
            -var "rds_master_password=${{ secrets.RDS_MASTER_PASSWORD }}"
        working-directory: ${{ env.TF_WORKING_DIR }}
        
  # Job 2: Terraform Apply
  terraform-apply:
    name: "Terraform Apply: Desplegar Cambios"
    runs-on: ubuntu-latest
    
    # Solo se ejecuta si es un push a la rama 'main'
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    # Depende del plan exitoso
    needs: terraform-plan 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # 4.1. Configurar Credenciales de AWS
      - name: Configure AWS Credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }} 
          aws-region: us-east-1 # CRÍTICO: Debe coincidir con prod.tfvars
          
      # 4.2. Terraform Init
      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      # 4.3. Terraform Apply (USANDO -var-file)
      - name: Terraform Apply
        run: |
          # Usamos el mismo patrón de variables para el apply que en el plan.
          terraform apply -auto-approve -input=false \
            -var-file="prod.tfvars" \
            -var "rds_master_password=${{ secrets.RDS_MASTER_PASSWORD }}"
        working-directory: ${{ env.TF_WORKING_DIR }}
